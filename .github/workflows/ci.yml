name: Auto Release with Changelog

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-build-release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0 # ★关键：必须拉取完整历史，否则无法计算两个Tag之间的差异
    
    # 1. 提取 POM 版本号
    - name: Extract version from pom.xml
      id: get_version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "Detected version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT

    # 2. 检查 Tag 是否已存在
    - name: Check if tag exists
      id: check_tag
      run: |
        if git rev-parse "${{ steps.get_version.outputs.tag }}" >/dev/null 2>&1; then
          echo "Tag ${{ steps.get_version.outputs.tag }} already exists."
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    # 3. ★核心新增：生成变更日志 (Changelog)
    - name: Generate Changelog
      if: steps.check_tag.outputs.exists == 'false'
      id: changelog
      run: |
        # 尝试获取上一个 Tag
        # 2>/dev/null 隐藏错误（如果是第一次发版，没有上一个Tag）
        PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        echo "Previous tag: $PREV_TAG"
        
        if [ -z "$PREV_TAG" ]; then
          # 如果没有上一个 Tag，说明是第一次发版，打印所有提交
          echo "No previous tag found. Logging all commits."
          LOGS=$(git log --pretty=format:"- %s (%h by %an)")
        else
          # 如果有上一个 Tag，打印该 Tag 到现在的提交
          echo "Generating log from $PREV_TAG to HEAD"
          LOGS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h by %an)")
        fi
        
        # 将多行文本写入 GITHUB_ENV (处理多行字符串的标准方式)
        {
          echo "RELEASE_BODY<<EOF"
          echo "## What's Changed in v${{ steps.get_version.outputs.version }}"
          echo ""
          echo "$LOGS"
          echo "EOF"
        } >> $GITHUB_ENV

    # 4. 设置 JDK 8
    - name: Set up JDK 8
      if: steps.check_tag.outputs.exists == 'false'
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: maven

    # 5. 构建项目
    - name: Build with Maven
      if: steps.check_tag.outputs.exists == 'false'
      run: mvn -B package -DskipTests --file pom.xml

    # 6. 创建 GitHub Release
    - name: Create Release
      if: steps.check_tag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: XiMultiLogin v${{ steps.get_version.outputs.version }}
        # ★这里使用了我们在步骤3生成的环境变量
        body: ${{ env.RELEASE_BODY }}
        files: target/XiMultiLogin-${{ steps.get_version.outputs.version }}.jar
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}